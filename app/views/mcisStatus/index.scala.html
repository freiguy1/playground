@(log: models.mcisStatus.Log)

@import java.time.OffsetDateTime
@import java.time.LocalDateTime
@import java.time.format.DateTimeFormatter
@import models.mcisStatus.StatusSegment

@lastOptionClass = @{
    log.segments.lastOption match {
        case Some(recent) => if(recent.isAvailable) "available" else "unavailable" 
        case None => "no-data"
    }
}

@dateTimeFormat(dateTime: Object) = @{
    val stringFormat = "M/d/yyyy 'at' h:mm:ss"
    dateTime match {
        case date: OffsetDateTime => date.format(DateTimeFormatter.ofPattern(stringFormat)) 
        case date: LocalDateTime => date.format(DateTimeFormatter.ofPattern(stringFormat)) 
    }
}

@timeFormat(dateTime: Object) = @{
    val stringFormat = "h:mm:ss"
    dateTime match {
        case date: OffsetDateTime => date.format(DateTimeFormatter.ofPattern(stringFormat)) 
        case date: LocalDateTime => date.format(DateTimeFormatter.ofPattern(stringFormat)) 
    }
}

@totalDurationTime = @{
    if(log.segments.isEmpty) {
        0
    } else {
        log.segments.foldLeft(0){(sum, listItem) =>
            sum + listItem.durationMinutes
        }
    }
}

@getTimePortion(time: Int) = @{
    val portionDouble = BigDecimal(time.toDouble / totalDurationTime.toDouble).setScale(4, BigDecimal.RoundingMode.HALF_UP).toDouble 
    portionDouble * 100
}

<!DOCTYPE html>
<html>
<head>
    <title>MCIS Clinicals Server Status</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <!-- CSS -->
    <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/bootstrap.min.css")">
    <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/mcis-status.css")">
    <link href='https://fonts.googleapis.com/css?family=Oxygen:400,700,300' rel='stylesheet' type='text/css'>
</head>
<body class="@lastOptionClass">
    <div class="hero">
        <div class="content">
            @defining(log.segments.lastOption) { mostRecent =>
                @mostRecent match {
                    case Some(recent) => {
                        <div class="hero-title">MCIS Services are</div>
                        @if(recent.isAvailable) {
                            <div class="hero-subtitle">Up and Running</div>
                        } else {
                            <div class="hero-subtitle">Down</div>
                        }
                    }
                    case None => {
                        <div class="hero-subtitle">No Data Available</div>
                    }
                }
            }
        </div>
    </div>
    
    <div class="content">
        <div class="details">
            <div class="details-header">
                <h3>Details</h3>
                <p>
                    Last refreshed at
                    <span id="last-refreshed" data-time="@log.lastRefresh.toInstant(java.time.ZoneOffset.UTC).toEpochMilli"></span>
                </p>
            </div>
            @defining(log.segments) { segments =>
                @if(segments.isEmpty) {
                    <p>Something went wrong while trying to grab the data. Please try again soon by refreshing the page.</p>
                } else {
                    <div class="history-log" data-total-time="@totalDurationTime">
                        @for(segment <- segments) {
                            @defining(getTimePortion(segment.durationMinutes) + "%") { portionDisplay =>
                            <div class="log-segment @if(segment.isAvailable) {available} else {unavailable}" style="width: @portionDisplay;"></div>
                            }
                        } 
                    </div>
                    <ul>
                        @for(segment <- segments) {
                            <li>
                                <span>@if(segment.isAvailable) { ON: } else { OFF: }</span>
                                <span>@dateTimeFormat(segment.startDateTime)</span>
                                <span>for @segment.durationMinutes minutes </span>
                            </li>
                        }
                    </ul>
                }
            }
        </div>
    </div>

    <!-- Javascripts -->
    <script src="@routes.Assets.at("javascripts/jquery-1.11.1.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/bootstrap.min.js")" type="text/javascript"></script>
    <script type="text/javascript">
        (function() {
            var date = new Date($('#last-refreshed').data('time'));
            $('#last-refreshed').html(date.toTimeString());
        })()
    </script>
</body>
</html>
